#!/usr/bin/env sh
set -e

R_HOME="${R_HOME:-$(R RHOME)}"
SOURCE="$(pwd)/inst/cli/rye"
TARGET_DIR=""

if [ ! -f "$SOURCE" ]; then
  echo "configure: missing ${SOURCE}" >&2
  exit 0
fi

if [ -n "${RYE_BIN_DIR:-}" ]; then
  TARGET_DIR="${RYE_BIN_DIR}"
elif [ -d "${HOME}/.local/bin" ] || mkdir -p "${HOME}/.local/bin" 2>/dev/null; then
  TARGET_DIR="${HOME}/.local/bin"
elif [ -d "${HOME}/bin" ] || mkdir -p "${HOME}/bin" 2>/dev/null; then
  TARGET_DIR="${HOME}/bin"
fi

if [ -n "${TARGET_DIR}" ] && [ -w "${TARGET_DIR}" ]; then
  TARGET="${TARGET_DIR}/rye"
  if ! cat > "${TARGET}" <<'EOF'
#!/usr/bin/env sh
set -e

if [ -z "$R_HOME" ]; then
  R_HOME="$(R RHOME)"
fi

exec "${R_HOME}/bin/Rscript" -e "rye:::rye_cli()" --args "$@"
EOF
  then
    echo "Failed to write rye CLI to ${TARGET}" >&2
    exit 0
  fi
  chmod +x "${TARGET}" 2>/dev/null || true
  echo "Installed rye CLI to ${TARGET}"
else
  echo "No writable bin directory found; rye CLI not installed on PATH." >&2
  echo "Set RYE_BIN_DIR to a writable directory or add one of these to PATH:" >&2
  echo "  ${HOME}/.local/bin" >&2
  echo "  ${HOME}/bin" >&2
fi
