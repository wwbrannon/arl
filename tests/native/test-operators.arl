;; Native tests for operators
;; Tests arithmetic, comparison, and logical operators with various arities

;; Arithmetic operators

(define test-addition-basic (lambda ()
  (assert-equal 3 (+ 1 2))
  (assert-equal 10 (+ 1 2 3 4))))

(define test-addition-variadic (lambda ()
  (assert-equal 0 (+))
  (assert-equal 5 (+ 5))
  (assert-equal 15 (+ 1 2 3 4 5))))

(define test-subtraction-basic (lambda ()
  (assert-equal 1 (- 3 2))
  (assert-equal -4 (- 1 2 3))))

(define test-subtraction-unary (lambda ()
  (assert-equal -5 (- 5))
  (assert-equal 5 (- -5))))

(define test-multiplication-basic (lambda ()
  (assert-equal 6 (* 2 3))
  (assert-equal 24 (* 2 3 4))))

(define test-multiplication-variadic (lambda ()
  (assert-equal 1 (*))
  (assert-equal 5 (* 5))
  (assert-equal 120 (* 1 2 3 4 5))))

(define test-division-basic (lambda ()
  (assert-equal 2 (/ 6 3))
  (assert-equal 2 (/ 12 2 3))))

(define test-division-single-arg (lambda ()
  (assert-equal 0.5 (/ 2))
  (assert-equal 0.25 (/ 4))))

;; Comparison operators

(define test-equality-basic (lambda ()
  (assert-true (== 1 1))
  (assert-true (! (== 1 2)))))

(define test-less-than-basic (lambda ()
  (assert-true (< 1 2))
  (assert-true (! (< 2 1)))))

(define test-less-equal-basic (lambda ()
  (assert-true (<= 1 2))
  (assert-true (<= 2 2))))

(define test-greater-than-basic (lambda ()
  (assert-true (> 2 1))
  (assert-true (! (> 1 2)))))

(define test-greater-equal-basic (lambda ()
  (assert-true (>= 2 1))
  (assert-true (>= 2 2))))

;; Logical operators

(define test-and-basic (lambda ()
  (assert-true (&& #t #t))
  (assert-true (! (&& #t #f)))
  (assert-true (! (&& #f #t)))
  (assert-true (! (&& #f #f)))))

(define test-or-basic (lambda ()
  (assert-true (|| #t #t))
  (assert-true (|| #t #f))
  (assert-true (|| #f #t))
  (assert-true (! (|| #f #f)))))

(define test-not-basic (lambda ()
  (assert-true (! #f))
  (assert-true (! (! #t)))))

;; Modulo and power

(define test-modulo-basic (lambda ()
  (assert-equal 1 (%% 5 2))
  (assert-equal 0 (%% 10 5))
  (assert-equal 2 (%% 12 5))))

(define test-power-basic (lambda ()
  (assert-equal 8 (^ 2 3))
  (assert-equal 1 (^ 5 0))
  (assert-equal 5 (^ 5 1))))

(define test-power-chaining (lambda ()
  ;; Test chained exponentiation: 2^(3^2) = 2^9 = 512
  (assert-equal 512 (^ 2 (^ 3 2)))
  ;; Verify this is different from (2^3)^2 = 8^2 = 64
  (assert-equal 64 (^ (^ 2 3) 2))))

;; Chained comparison tests

(define test-less-than-chained (lambda ()
  ;; Test that comparisons can chain: 1 < 2 < 3
  (assert-true (< 1 2 3))
  (assert-true (< 1 2 3 4 5))
  ;; 1 < 3 but not 3 < 2
  (assert-true (! (< 1 3 2)))
  ;; 1 < 2 but not 2 < 2
  (assert-true (! (< 1 2 2)))))

(define test-less-equal-chained (lambda ()
  (assert-true (<= 1 2 3))
  ;; allows equality
  (assert-true (<= 1 2 2 3))
  (assert-true (! (<= 1 3 2)))))

(define test-greater-than-chained (lambda ()
  (assert-true (> 3 2 1))
  (assert-true (! (> 1 2 3)))))

(define test-greater-equal-chained (lambda ()
  (assert-true (>= 3 2 1))
  (assert-true (>= 3 2 2 1))
  (assert-true (! (>= 1 2 3)))))

(define test-equality-chained (lambda ()
  (assert-true (== 2 2 2))
  (assert-true (! (== 1 1 2)))))

;; Variadic comparisons with many arguments (the variadic comparison
;; implementation uses an internal while loop, so many args won't blow the stack)
(define test-variadic-comparison-many-args (lambda ()
  ;; Build list of 100 equal values for ==
  (define hundred (iota 100))
  (define all-ones (lapply hundred (lambda (i) 1)))
  (assert-true (funcall == all-ones))
  ;; Build strictly increasing list for <
  (assert-true (funcall < hundred))
  ;; Mismatch in middle: == should be #f
  (define with-mismatch (append (list 1 1 1) (list 2) (lapply (iota 95) (lambda (i) 1))))
  (assert-true (! (funcall == with-mismatch)))))
