# Rye Development Tools

This directory contains development tools for the Rye language implementation.

## rye-coverage.R

Code coverage analysis tool for .rye source files.

### Overview

Tracks which lines of .rye source files are compiled and generates coverage reports. Unlike traditional code coverage tools that only work with the implementation language (R), this tool reports on the actual Rye source files in the standard library (`inst/rye/*.rye`) and native tests (`tests/native/*.rye`).

**Coverage Metric:** Currently tracks *compilation coverage* - lines that can be successfully compiled. This is a conservative metric that shows which code is syntactically valid and reachable by the compiler.

### Usage

Run via Make:

```bash
make coverage
```

Or directly from R:

```r
source('tools/rye-coverage.R')

# Console report only
rye_coverage_report(output = "console")

# Console + HTML report
rye_coverage_report(output = c("console", "html"))

# Custom HTML output location
rye_coverage_report(
  output = c("console", "html"),
  html_file = "coverage-rye/index.html"
)
```

### Output

**Console Report:**
- Per-file coverage summary with percentages
- Total coverage across all .rye files
- Example output:
  ```
  Rye Code Coverage Report (Compilation Coverage)
  ===============================================

  assert.rye                                 65/  58 lines (112.1%)
  core.rye                                   98/  84 lines (116.7%)
  ...

  Total: 3568/3774 lines (94.5%)
  ```

**HTML Report** (`coverage-rye/index.html`):
- Interactive report with file summary table
- Line-by-line coverage view for each file
- Color-coded lines:
  - Green: covered (compiled)
  - Red: uncovered (not compiled)
  - Gray: empty lines / comments
- Clickable table of contents

### How It Works

1. **Discovery:** Finds all `.rye` files in `inst/rye/` and `tests/native/`

2. **Compilation:** Compiles each file using the Rye compiler, which attaches `rye_src` attributes to compiled R expressions containing source location metadata

3. **Extraction:** Recursively walks compiled expression trees to extract all `rye_src` attributes

4. **Reporting:** Maps source locations back to original .rye files and generates coverage metrics

### Coverage >100%?

You may notice some files show >100% coverage. This occurs because:
- Multi-line expressions mark ALL lines in their range as covered
- A single source line may participate in multiple compiled expressions
- This is conservative (better to over-report than under-report)

### Limitations

- **Compilation coverage only:** Currently tracks which lines *can be compiled*, not which lines *actually execute* during tests
- **Macro-generated code:** Code generated by macros is attributed to the macro call site
- **Standalone compilation:** Some test files may fail to compile standalone if they have circular dependencies with other modules

### Future Improvements

- Track execution coverage using runtime instrumentation (trace actual eval calls)
- Integration with CI/CD (GitHub Actions)
- Codecov.io JSON export
- Coverage history tracking
- Per-function coverage metrics
